<link rel="import" href="../behaviors/AgsFieldStamper.html">
<!--
@demo demo/ags-field.html
-->
<dom-module id="ags-field">
    <template><div id="fallbackField">
    <template is="dom-if" if="[[property]]">
        <template is="dom-if" if="[[noTemplateFound]]">
            <input type="text" value="{{value::input}}" required$="[[required]]"/>
        </template>
    </template>
    </div>

    <div id="dynamicField"></div>
    </template>
    <script>
        (function() {
            "use strict";

            var AgsField = Polymer({
                is: "ags-field",
                properties: {
                    property: {
                        type: String,
                        value: null
                    },
                    range: {
                        type: String,
                        value: null
                    },
                    value: {
                        type: Object,
                        value: null,
                        notify: true,
                        observer: "_valueChanged"
                    },
                    noTemplateFound: {
                        type: Boolean,
                        readOnly: true
                    },
                    required: {
                        type: Boolean,
                        value: false
                    }
                },
                observers: ["_draw(property, range)"],
                behaviors: [Augeas.AgsFieldStamper],
                ready: function() {
                    this._instanceProps = {
                        value: true
                    };
                },
                _valueChanged: function(newValue) {
                    if (this._stampedTemplate) {
                        this._stampedTemplate.value = newValue;
                    }
                },
                _draw: function(property, range) {
                    var _this = this;
                    this.async(function() {
                        var templates = _this._getTemplates('form') || [];
                        var found = false;
                        var elementRoot = Polymer.dom(_this.$.dynamicField);
                        while (elementRoot.firstChild) {
                            elementRoot.removeChild(elementRoot.firstChild);
                        }
                        for (var i = templates.length - 1; i >= 0; i--) {
                            var template_1 = templates[i];
                            if (!template_1.template || !template_1.isMatch || !template_1.isMatch(property, range))
                                continue;
                            found = true;
                            _this.templatize(template_1.template);
                            _this._stampedTemplate = _this.stamp({
                                value: _this.value
                            });
                            elementRoot.appendChild(_this._stampedTemplate.root);
                            notifyStamped(template_1, _this.value);
                            break;
                        }
                        _this._setNoTemplateFound(!found);
                    });
                },
                _forwardInstanceProp: function(inst, path, value) {
                    if (this.value != value) {
                        this.set(path, value);
                    }
                }
            });

            function notifyStamped(template, value) {
                template.dispatchEvent(new CustomEvent('stamped', {
                    detail: {
                        value: value
                    }
                }));
            }

        }());

    </script>
</dom-module>
