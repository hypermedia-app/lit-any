<link rel="import" href="../behaviors/RegisteredTemplateConsumer.html">

<dom-module id="ags-view">
    <template><style>:host {
            display: block;
            @apply(--object-view);
        }</style>
</template>
    <script>
        (function() {
            "use strict";

            var AgsView = Polymer({
                is: "ags-view",
                properties: {
                    object: {
                        type: Object
                    },
                    predicate: {
                        type: String,
                        value: null
                    },
                    templateScope: {
                        type: String,
                        value: ''
                    },
                    ignoreMissing: {
                        type: Boolean,
                        value: false
                    },
                    hasBeenRendered: {
                        type: Boolean,
                        value: false,
                        readOnly: true,
                        notify: true
                    },
                    params: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    }
                },
                observers: ["_draw(object, predicate, templateScope, ignoreMissing, params)"],
                behaviors: [Augeas.RegisteredTemplateConsumer],
                attached: function() {
                    var _this = this;
                    document.addEventListener('ags-templates', (function() {
                        if (_this.object) {
                            _this._draw(_this.object, _this.predicate, _this.templateScope, _this.ignoreMissing, _this.params);
                        }
                    }).bind(this));
                },
                _draw: function(object, predicate, templateScope, ignoreMissing, params) {
                    var _this = this;
                    var templates = this._getTemplates('view') || [];
                    var found;
                    var elementRoot = Polymer.dom(this.root);
                    while (elementRoot.firstChild) {
                        elementRoot.removeChild(elementRoot.firstChild);
                    }
                    for (var i = 0; i < templates.length; i++) {
                        var template = templates[i];
                        if (!template.template)
                            continue;
                        if (!template.isMatch)
                            continue;
                        if (!template.isMatch(object, predicate, templateScope))
                            continue;
                        found = true;
                        if (template.name) {
                            this.setAttribute('data-template', template.name);
                        }
                        this.getStamped(this, template, object)
                            .then(function(stamped) {
                                return replaceContent.call(_this, elementRoot, stamped);
                            })
                            .then(function(_) {
                                return notifyStamped(template, object);
                            });
                        break;
                    }
                    if (!found && !ignoreMissing) {
                        var notFoundNode = document.createElement('div');
                        notFoundNode.textContent = 'Template Not found';
                        replaceContent.call(this, elementRoot, notFoundNode);
                        console.warn('Template not found for', object);
                    }
                }
            });

            function replaceContent(elementRoot, newContent) {
                elementRoot.appendChild(newContent);
                this._setHasBeenRendered(true);
            }

            function notifyStamped(template, object) {
                template.dispatchEvent(new CustomEvent('stamped', {
                    detail: {
                        object: object
                    }
                }));
            }

        }());

    </script>
</dom-module>
