<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ags-view tests</title>
    <script src="../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../bower_components/web-component-tester/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.11/jsonld.min.js"></script>
    <script src="../_TestHelpers.js"></script>
    <link rel="import" href="../../augeas.html" />
    <link rel="import" href="../test-elements/contains-templates.html"/>
</head>
<body>

<test-fixture id="single-template">
    <template>
        <ags-object-template>
            <template>
                <span>I'm first</span>
            </template>
        </ags-object-template>

        <ags-view></ags-view>
    </template>
</test-fixture>

<test-fixture id="multiple-matching-templates">
    <template>
        <ags-object-template id="first">
            <template>
                <span>I'm first</span>
            </template>
        </ags-object-template>

        <ags-object-template>
            <template>
                <span>I'm second</span>
            </template>
        </ags-object-template>

        <ags-view></ags-view>
    </template>
</test-fixture>

<test-fixture id="view-with-params">
    <template>
        <ags-object-template>
            <template>
                <span>[[params.value]]</span>
            </template>
        </ags-object-template>

        <ags-view params='{ "value": "some text" }'></ags-view>
    </template>
</test-fixture>

<test-fixture id="default-bound-variable">
    <template>
        <ags-object-template>
            <template>
                <span>[[model.value]]</span>
            </template>
        </ags-object-template>

        <ags-view></ags-view>
    </template>
</test-fixture>

<test-fixture id="custom-bound-variable">
    <template>
        <ags-object-template as="myVariable">
            <template>
                <span>[[myVariable.value]]</span>
            </template>
        </ags-object-template>

        <ags-view></ags-view>
    </template>
</test-fixture>

<script>

    describe('ags-view', function () {

        var view;

        it('should fire stamped event on selected template', function(done) {
            //given
            var fixtureElements = fixture('single-template');
            var template = fixtureElements[0];
            view = fixtureElements[1];

            // when
            view.object = {'@id': '_:test'};

            // then
            testHandler(template, 'stamped', function(e) {
                assert.equal(e.detail.object, view.object);
                done();
            });
        });

        it('should bind with "model" variable', function(done) {
            // given
            view = fixture('default-bound-variable')[1];

            // when
            view.object = {
              '@id': 'test',
              value: 'test'
            };

            // then
            flush(function() {
                var span = view.querySelector('span');
                assert.equal('test', span.textContent);
                done();
            });
        });

      it('should bind with changed variable', function(done) {
        // given
        view = fixture('custom-bound-variable')[1];

        // when
        view.object = {
          '@id': 'test',
          value: 'test'
        };

        // then
        flush(function() {
          var span = view.querySelector('span');
          assert.equal('test', span.textContent);
          done();
        });
      });

        describe('multiple matching templates', function () {

            beforeEach(function () {
                view = fixture('multiple-matching-templates')[2];
            });

            it('should render first match', function (done) {
                view.object = {'@id': '_:test'};

                flush(function () {
                    assert.equal("I'm first", view.querySelector('span').textContent);
                    done();
                });
            });
        });

        describe('multiple matching templates, loaded dynamically', function () {

            var dynTemplate, fixtureElement = document.querySelector('#multiple-matching-templates');

            beforeEach(function () {
                view = fixture('multiple-matching-templates')[2];

                dynTemplate = document.createElement('contains-templates');
            });

            it('should render first match', function (done) {
                dynTemplate.text = 'I was loaded dynamically';
                fixtureElement.insertBefore(dynTemplate, document.querySelector('#first'));

                view.object = {'@id': '_:test'};

                flush(function () {
                    assert.equal("I was loaded dynamically", view.querySelector('span').textContent);
                    done();
                });
            });
        });

        describe('view with params set', function () {

            beforeEach(function () {
                view = fixture('view-with-params')[1];
            });

            it('should pass params to template', function (done) {
                view.object = {'@id': '_:test'};

                flush(function () {
                    assert.equal("some text", view.querySelector('span').textContent);
                    done();
                });
            });

        });

    });

</script>
</body>
</html>