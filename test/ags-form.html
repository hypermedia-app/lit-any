<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ags-form tests</title>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="../bower_components/polymer/polymer.html"/>
    <link rel="import" href="../bower_components/polymer-ts/polymer-ts.html"/>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.11/jsonld.min.js"></script>
    <link rel="import" href="../augeas.html" />
    <link rel="import" href="test-elements/fake-ags-field.html" />
</head>
<body>

<test-fixture id="no-fields-fixture">
    <template>
        <ags-form></ags-form>
    </template>
</test-fixture>

<script>

    var subject;

    describe('ags-form', function () {

        it('should be registered', function () {
            subject = fixture('no-fields-fixture');

            assert.notEqual(document.createElement('ags-form').constructor, HTMLElement);
        });

        it('should have null value by default', function () {
            subject = fixture('no-fields-fixture');

            assert.strictEqual(subject.value, null);
        });

        it('should render ags-field for each property', function (done) {
            subject = fixture('no-fields-fixture');

            subject.contract = contract;

            flush(function () {
                var fields = document.querySelectorAll('ags-form /deep/ ags-field');
                assert.equal(fields.length, 2);
                assert.equal(fields[0].property, 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title');
                assert.equal(fields[0].range, 'http://www.w3.org/2001/XMLSchema#string');
                assert.equal(fields[1].property, 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/createdAt');
                assert.equal(fields[1].range, 'http://www.w3.org/2001/XMLSchema#dateTime');
                done();
            });

        });

        describe('when ags-fields notify', function () {

            beforeEach(function() {
                replace('ags-field').with('fake-ags-field');

                subject = fixture('no-fields-fixture');
            });

            it('value should equal JSON-LD object with field values', function(done) {

                subject.contract = contract;

                flush(function() {
                    var i = 1;
                    document.querySelectorAll('body /deep/ fake-ags-field')
                            .forEach(function(field) {
                                field.value = 'value ' + i++;
                            });

                    assert.deepEqual(subject.value, {
                        'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title': [
                            { '@value': 'value 1' }
                        ],
                        'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/createdAt': [
                            { '@value': 'value 2' }
                        ]
                    });

                    done();
                });
            });

            it('should notify value', function(done) {
                subject.contract = contract;

                subject.addEventListener('value-changed', function(e) {
                    assert.isNotNull(e.detail.value);

                    done();
                });

                flush(function() {
                    var i = 1;
                    document.querySelectorAll('body /deep/ fake-ags-field')
                            .forEach(function(field) {
                                field.value = 'value ' + i++;
                            });
                });
            });

        });
    });

    var contract = {
        body: [
            {
                property: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title',
                range: 'http://www.w3.org/2001/XMLSchema#string'
            },
            {
                property: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/createdAt',
                range: 'http://www.w3.org/2001/XMLSchema#dateTime'
            }
        ]
    };

</script>
</body>
</html>