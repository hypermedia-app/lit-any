<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ags-form tests</title>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.11/jsonld.min.js"></script>
    <link rel="import" href="../dist/elements/ags-field.html"/>
    <script src="_TestHelpers.js"></script>
</head>
<body>

<test-fixture id="no-field-templates">
    <template>
        <ags-field></ags-field>
    </template>
</test-fixture>

<test-fixture id="field-with-property">
    <template>
        <ags-field property="http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title"></ags-field>
    </template>
</test-fixture>

<test-fixture id="field-required">
    <template>
        <ags-field required property="http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title"></ags-field>
    </template>
</test-fixture>

<test-fixture id="field-template-by-property">
    <template is="dom-template">
        <template is="ags-field-property-template" property="{{templateProperty}}">
            <textarea value="{{value::input}}"></textarea>
        </template>

        <ags-field property="{{fieldProperty}}" range="{{fieldRange}}"></ags-field>
    </template>
</test-fixture>

<test-fixture id="field-template-by-range">
    <template is="dom-template">
        <template is="ags-field-range-template" range="{{templateRange}}">
            <textarea value="{{value::input}}"></textarea>
        </template>

        <ags-field property="{{fieldProperty}}" range="{{fieldRange}}"></ags-field>
    </template>
</test-fixture>

<test-fixture id="field-multiple-range-templates">
    <template>
        <ags-field property="http://some.prop" range="http://www.w3.org/2001/XMLSchema#string"></ags-field>

        <template is="ags-field-range-template" range="http://www.w3.org/2001/XMLSchema#string">
            <textarea first></textarea>
        </template>

        <template is="ags-field-range-template" range="http://www.w3.org/2001/XMLSchema#string">
            <textarea last></textarea>
        </template>
    </template>
</test-fixture>

<test-fixture id="field-multiple-property-templates">
    <template>
        <ags-field property="http://www.w3.org/2001/XMLSchema#string"></ags-field>

        <template is="ags-field-property-template" property="http://www.w3.org/2001/XMLSchema#string">
            <textarea first></textarea>
        </template>

        <template is="ags-field-property-template" property="http://www.w3.org/2001/XMLSchema#string">
            <textarea last></textarea>
        </template>
    </template>
</test-fixture>

<script>

    var subject;

    describe('ags-field', function () {

        describe('with property not set', function() {

            beforeEach(function(){
                subject = fixture('no-field-templates');
            });

            it('should render no field', function (done) {
                flush(function () {
                    var children = subject.querySelectorAll('input');

                    assert.equal(children.length, 0);
                    done();
                });
            });
        });

        describe('with no matching template', function () {

            it('should render a text input', function (done) {
                subject = fixture('field-with-property');

                flush(function () {
                    var field = subject.querySelector('input');

                    assert.equal(field.constructor, HTMLInputElement);
                    assert.equal(field.type, 'text');
                    done();
                });
            });

            it('should make the default input required when necessary', function (done) {
                subject = fixture('field-required');

                flush(function () {
                    var field = subject.querySelector('input');

                    assert.isNotNull(field.getAttribute('required'));
                    done();
                });
            });

            it('should set value property when input value is set', function (done) {
                subject = fixture('field-with-property');

                flush(function () {
                    var input = subject.querySelector('input');

                    setInputValue(input, 'I wrote this');

                    assert.equal(subject.value, 'I wrote this');
                    done();
                });
            });
        });

        describe('with template matched by property', function() {
            beforeEach(function(){
                subject = fixture('field-template-by-property', {
                    templateProperty: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/description',
                    fieldProperty: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/description'
                })[1];
            });

            it('should render the template', function(done) {
                flush(function() {
                  debugger;
                    var textarea = subject.$$('textarea');

                    assert.isNotNull(textarea);
                    done();
                });
            });

            it('should notify value when field changes', function(done) {
                var inputText = 'some test text';

                subject.addEventListener('value-changed', function(e) {
                    assert.equal(e.detail.value, inputText);
                    assert.equal(subject.value, inputText);

                    done();
                });

                flush(function() {
                    var textarea = subject.$$('textarea');

                    setInputValue(textarea, inputText);
                });
            });
        });

        describe('with template matched by range', function() {
            beforeEach(function(){
                subject = fixture('field-template-by-range', {
                    templateRange: 'http://www.w3.org/2001/XMLSchema#string',
                    fieldRange: 'http://www.w3.org/2001/XMLSchema#string'
                })[1];
            });

            it('should render the template', function(done) {
                flush(function() {
                    var textarea = subject.$$('textarea');

                    assert.isNotNull(textarea);
                    done();
                });
            });
        });

        describe('when multiple templates match property', function() {
            beforeEach(function(){
                subject = fixture('field-multiple-property-templates')[0];
            });

            it('should select last', function(done) {
                flush(function() {
                    assert.isNotNull(subject.$$('textarea[last]'));
                    assert.isNull(subject.$$('textarea[first]'));
                    done();
                });
            });
        });

        describe('when multiple templates match range', function() {
            beforeEach(function(){
                subject = fixture('field-multiple-range-templates')[0];
            });

            it('should select last', function(done) {
                flush(function() {
                    assert.isNotNull(subject.$$('textarea[last]'));
                    assert.isNull(subject.$$('textarea[first]'));
                    done();
                });
            });
        });
    });

</script>
</body>
</html>