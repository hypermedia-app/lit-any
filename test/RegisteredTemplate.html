<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RegisteredTemplate tests</title>
    <script src="../jspm_packages/system.js"></script>
    <script src="../config.js"></script>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="../bower_components/polymer/polymer.html"/>
    <link rel="import" href="../bower_components/polymer-ts/polymer-ts.html"/>
    <script src="../bower_components/web-component-tester/browser.js"></script>
</head>
<body>

    <template id="defaults" is="test-registered-template">
    </template>

    <template id="with-scope" is="test-registered-template" scope="some scope"></template>
    <template id="to-remove" is="test-registered-template"></template>

    <script>

        var subject;
        describe('RegisteredTemplate', function () {

            describe('defaults', function () {

                before(function () {
                    subject = document.getElementById('defaults');
                });

                describe('as property', function () {

                    it('should equal "model"', function (done) {

                        System.import('test/test-elements/test-registered-template')
                                .then(function () {
                                    assert.equal(subject.as, 'model');
                                    done();
                                })
                                .catch(done.fail);
                    });

                });

                describe('name property', function () {

                    it('should be empty string', function (done) {

                        System.import('test/test-elements/test-registered-template')
                                .then(function () {
                                    assert.equal(subject.name, '');
                                    done();
                                })
                                .catch(done.fail);
                    });

                });

                describe('scope property', function () {

                    it('should be empty string', function (done) {

                        System.import('test/test-elements/test-registered-template')
                                .then(function () {
                                    assert.equal(subject.scope, '');
                                    done();
                                })
                                .catch(done.fail);
                    });

                });

                describe('compactWith property', function () {

                    it('should be null', function (done) {

                        System.import('test/test-elements/test-registered-template')
                                .then(function () {
                                    assert.equal(subject.compactWith, null);
                                    done();
                                })
                                .catch(done.fail);
                    });

                });

                describe('predicate property', function () {

                    it('should be null', function (done) {

                        System.import('test/test-elements/test-registered-template')
                                .then(function () {
                                    assert.equal(subject.predicate, null);
                                    done();
                                })
                                .catch(done.fail);
                    });

                });

            });

            describe('adding to DOM', function () {

                var node, listener;

                it('raises an event', function (done) {

                    listener = function(e) {
                        assert.equal(e.detail.templates.length, 4);
                        assert.equal(e.detail.templates[3].id, 'dynamic');
                        done();
                    };

                    System.import('test/test-elements/test-registered-template')
                            .then(function () {
                                node = document.createElement('template', 'test-registered-template');
                                node.setAttribute('id', 'dynamic');

                                document.addEventListener('ags-templates-changed', listener);
                                document.body.appendChild(node);
                            });
                });

                afterEach(function() {
                    document.removeEventListener('ags-templates-changed', listener);
                    document.body.removeChild(node);
                });

            });

            describe('removing from DOM', function () {

                var node, listener;

                it('raises an event', function (done) {

                    listener = function(e) {
                        assert.equal(e.detail.templates.length, 2);
                        done();
                    };

                    System.import('test/test-elements/test-registered-template')
                            .then(function () {
                                node = document.getElementById('to-remove');

                                document.addEventListener('ags-templates-changed', listener);

                                document.body.removeChild(node);
                            });
                });

                afterEach(function() {
                    document.removeEventListener('ags-templates-changed', listener);
                });

            });

            describe('isMatch method', function() {

                it('matches when scope matches', function() {

                    subject = document.getElementById('with-scope');

                    var isMatch = subject.isMatch({}, null, 'some scope');

                    assert.equal(isMatch, true);

                });

                it('doesn\'t match when predicate is provided and not set on template', function() {

                    subject = document.getElementById('defaults');

                    var isMatch = subject.isMatch({}, 'some predicate');

                    assert.equal(isMatch, false);

                });

            });
        });

    </script>
</body>
</html>