<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ags-hydra-adapter tests</title>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="../bower_components/polymer/polymer.html"/>
    <link rel="import" href="../bower_components/polymer-ts/polymer-ts.html"/>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.11/jsonld.min.js"></script>
    <link rel="import" href="../augeas.html"/>
</head>
<body>

<test-fixture id="ags-hydra-adapter">
    <template>
        <ags-hydra-adapter></ags-hydra-adapter>
    </template>
</test-fixture>

<script>

    describe('ags-hydra-adapter', function () {

        var adapter = fixture('ags-hydra-adapter');

        it('should translate heracles operation properties to contract body', function () {
            // given
            var operation = {
                expects: {
                    supportedProperties: [
                        {
                            title: 'Issue title',
                            description: 'Issue title longer',
                            writable: true,
                            required: true,
                            property: {
                                id: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title',
                                range: {
                                    id: 'http://www.w3.org/2001/XMLSchema#string'
                                }
                            }
                        },
                        {
                            title: 'Issue description',
                            description: 'Issue description longer',
                            writable: true,
                            required: false,
                            property: {
                                id: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/description',
                                range: {
                                    id: 'http://www.w3.org/2001/XMLSchema#string'
                                }
                            }
                        }
                    ]
                }
            };

            // when
            adapter.operation = operation;

            // then
            assert.deepEqual(adapter.contract.body,[
                {
                    title: 'Issue title',
                    description: 'Issue title longer',
                    property: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/title',
                    range: 'http://www.w3.org/2001/XMLSchema#string',
                    required: true
                },
                {
                    title: 'Issue description',
                    description: 'Issue description longer',
                    property: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/description',
                    range: 'http://www.w3.org/2001/XMLSchema#string',
                    required: false
                }
            ]);
        });

        it('should skip read-only hydra properties', function () {
            // given
            var operation = {
                expects: {
                    supportedProperties: [
                        {
                            writable: false,
                            property: {
                                id: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/dbid',
                                range: {
                                    id: 'http://www.w3.org/2001/XMLSchema#int'
                                }
                            }
                        }
                    ]
                }
            };

            // when
            adapter.operation = operation;

            // then
            assert.equal(adapter.contract.body.length, 0);
        });

        it('should notify contract change', function(done) {
            // given
            var operation = {
                expects: {
                    supportedProperties: [
                        {
                            writable: false,
                            property: {
                                id: 'http://www.markus-lanthaler.com/hydra/api-demo/vocab#Issue/dbid',
                                range: {
                                    id: 'http://www.w3.org/2001/XMLSchema#int'
                                }
                            }
                        }
                    ]
                }
            };
            adapter.addEventListener('contract-changed', changeCallback);

            // when
            adapter.operation = operation;

            // then
            function changeCallback() {
                adapter.removeEventListener('contract-changed', changeCallback);
                done();
            }
        });

        it('should copy operation title and description', function () {
            // given
            var operation = {
                title: 'Some operation',
                description: 'its longer, informative description',
                expects: {
                    supportedProperties: [ ]
                }
            };

            // when
            adapter.operation = operation;

            // then
            assert.equal('Some operation', adapter.contract.title);
            assert.equal('its longer, informative description', adapter.contract.description);
        });

        it('should handle missing expects gracefully', function () {
            // given
            var operation = {
            };

            // when
            adapter.operation = operation;

            // then
            assert.equal(adapter.contract.body.length, 0);
        });

        it('should handle missing supported properties gracefully', function () {
            // given
            var operation = {
                expects: {}
            };

            // when
            adapter.operation = operation;

            // then
            assert.equal(adapter.contract.body.length, 0);
        });
    });

</script>
</body>
</html>